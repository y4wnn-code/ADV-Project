<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>dashboard</title>
<link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-d3x1k5e7ZcQb3gQxJd3V/8C9yFQyq6qYcI1oZ6z1pQkq5Yk6O0bYbX2F0E2Gm1Tz0+/Eg8JjY9B1x3w2b3wQ2g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
<div class="top-bar">
  <div class="app-title">bloggwatch.</div>
  <button class="logout-btn" id="logout">logout</button>
</div>
<div class="container">
  <div class="dashboard-top">
    <div class="user-card">
      <div class="user-info no-bg">
        <img id="pfp" class="pfp" src="/default-pfp.png">
        <div class="user-text">
                <div style="display:flex;align-items:center;gap:8px">
                  <div id="uname" class="user-name-bold" style="cursor:pointer;text-decoration:underline;color:inherit"></div>
                </div>
                <div style="margin-top:4px">
                  <button id="editBioBtn" title="Edit bio" class="edit-bio-link" style="background:none;border:none;cursor:pointer;font-size:12px;padding:0;color:#2563eb;text-decoration:underline">Edit Bio</button>
                </div>
                <div style="display:flex;align-items:center;gap:8px;max-width:100%;margin-top:6px">
                  <div id="bio" style="font-size:12px;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1"></div>
                </div>
                <div id="pc" class="post-count"></div>
          </div>
      </div>
    </div>
    <div class="search-card">
      <div class="search-wrap">
        <input id="search" class="search-bar" placeholder="Search a movie/series...">
      </div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <button id="searchBtn" class="search-btn" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:#fff;cursor:pointer">Search</button>
        </div>
    </div>
  </div>

  <div class="new-post">
    <div class="new-row">
      <input id="title" class="input-title" placeholder="Title">
      <input id="year" class="input-year" placeholder="Year">
    </div>
    <div class="content-row">
      <textarea id="content" class="input-content" placeholder="Share your opinion..."></textarea>
      <div class="post-btn-wrap">
        <button id="postBtn" class="post-btn">Post</button>
      </div>
    </div>
  </div>

  <div class="feed-header" style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;margin-bottom:8px">
    <div style="font-size:13px;font-weight:700">Feed</div>
    <div style="display:flex;align-items:center;gap:8px">
      <label style="font-size:12px;color:#555;margin-right:6px">Sort</label>
      <select id="sortSelect" style="padding:6px;border-radius:8px;border:1px solid #ddd;background:#fff">
        <option value="latest">Latest</option>
        <option value="oldest">Oldest</option>
      </select>
    </div>
  </div>

  <div class="feed" id="feed"></div>
</div>

  <div class="nav-bottom">
  <button class="nav-btn" id="navFeed">Feed</button>
  <button class="nav-btn" id="navYou">You</button>
  <button class="nav-btn" id="navNotif">Notifications</button>
</div>

<input type="file" id="pfpInput" style="display:none" accept="image/*" aria-label="Upload profile picture">
<div id="toast" style="position:fixed;right:18px;bottom:18px;display:none;z-index:60;padding:8px 12px;border-radius:8px;background:rgba(0,0,0,0.75);color:#fff;font-size:13px"></div>

<script>
const user = (localStorage.getItem('username') || '').trim();
if (!user) location.href = '/login.html';
document.getElementById('uname').innerText = user;
document.getElementById('logout').addEventListener('click', ()=>{ localStorage.removeItem('username'); location.href='/login.html'; });

  const pfpEl = document.getElementById('pfp');
const pfpInput = document.getElementById('pfpInput');

  pfpEl.addEventListener('click', ()=> pfpInput.click());
  
  document.getElementById('uname').addEventListener('click', ()=>{ location.href = '/profile.html?username='+encodeURIComponent(user); });
  pfpEl.addEventListener('click', ()=>{}); 

pfpInput.addEventListener('change', async function(){
  const file = this.files[0];
  if (!file) return;
  const fd = new FormData();
  fd.append('pfp', file);
  fd.append('username', user);
    try {
    const res = await fetch('/upload-pfp', { method:'POST', body: fd });
    let data = null;
    try { data = await res.json(); } catch(e) { }
    if (!res.ok) {
      const msg = (data && (data.error||data.message)) || res.statusText || 'upload failed';
      console.error('upload-pfp failed', res.status, msg, data);
      alert('Profile upload failed: ' + msg);
      return;
    }
    if (data && data.pfp) {
      pfpEl.src = data.pfp + '?t=' + Date.now();
      console.log('upload-pfp success response', data);
      try { fetch('/api/user/'+user).then(r=>r.json()).then(u=>{ if (u && u.pfp) pfpEl.src = u.pfp + '?t=' + Date.now(); }); } catch(e){}
      const t = document.getElementById('toast'); t.innerText = 'Profile picture updated'; t.style.display='block'; setTimeout(()=> t.style.display='none',1800);
      pfpEl.style.boxShadow = '0 4px 18px rgba(59,130,246,0.25)';
      setTimeout(()=> pfpEl.style.boxShadow = '', 1200);
    } else if (data && data.filename) {
      pfpEl.src = data.filename + '?t=' + Date.now();
    } else {
      console.error('Upload failed', data);
      alert('Profile upload failed — see developer console for details.');
    }
  } catch (err) {
    console.error('Upload error', err);
    alert('Profile upload failed (network or server error).');
  }
});


async function loadPostCount(){
  const res = await fetch('/api/posts/count/'+user);
  const d = await res.json();
  document.getElementById('pc').innerText = 'Posts: '+ (d.count||0);
}
loadPostCount();

let postsCache = [];
const reactionLocks = {};
const pfpCache = {}; 


async function loadCurrentUser(){
  try{
    const res = await fetch('/api/user/'+user);
    if (!res.ok) return;
    const u = await res.json();
    if (u && u.pfp) {
      pfpEl.src = u.pfp + '?t=' + Date.now();
      pfpCache[user] = u.pfp;
      const bioEl = document.getElementById('bio');
      bioEl.innerText = u.bio ? u.bio : '';
    }
  }catch(e){ console.error('load current user pfp', e); }
}
loadCurrentUser();


document.getElementById('editBioBtn').addEventListener('click', ()=>{
  const bioEl = document.getElementById('bio');
  const current = bioEl.innerText || '';

  if (bioEl.getAttribute('data-editing') === '1') return;
  bioEl.setAttribute('data-editing','1');
  const input = document.createElement('input'); input.type='text'; input.maxLength=60; input.value = current; input.style.width='100%'; input.style.boxSizing='border-box';
  const save = document.createElement('button'); save.innerText='Save'; save.style.marginLeft='8px';
  const cancel = document.createElement('button'); cancel.innerText='Cancel'; cancel.style.marginLeft='8px';
  const parent = bioEl.parentNode;
  const wrapper = document.createElement('div'); wrapper.style.display='flex'; wrapper.style.alignItems='center'; wrapper.appendChild(input); wrapper.appendChild(save); wrapper.appendChild(cancel);
  parent.replaceChild(wrapper, bioEl);

  cancel.addEventListener('click', ()=>{ wrapper.parentNode.replaceChild(bioEl, wrapper); bioEl.removeAttribute('data-editing'); });
  save.addEventListener('click', async ()=>{
    const val = input.value.trim();
    if (val.length > 60) { alert('Bio must be 60 characters or fewer'); return; }
    try{
      
      console.log('bio-save: trying /api/user/'+encodeURIComponent(user)+'/bio');
      let r = await fetch('/api/user/'+encodeURIComponent(user)+'/bio', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ bio: val, requester: user }) });
      let data = null;
      try { data = await r.json(); } catch(e) { /* ignore non-json */ }
      if (!r.ok) {
        console.warn('bio-save: primary failed', r.status, data);
       
        if (r.status === 404) {
          try {
            console.log('bio-save: trying fallback /api/user/bio');
            r = await fetch('/api/user/bio', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username: user, bio: val, requester: user }) });
            try { data = await r.json(); } catch(e) { data = null; }
            if (!r.ok) {
              const msg = (data && (data.error||data.message)) || r.statusText || 'unknown error';
              const t = document.getElementById('toast'); t.innerText = 'Save failed: ' + msg; t.style.display='block'; setTimeout(()=> t.style.display='none',3200);
              return;
            }
          } catch(e){ console.error('fallback save err', e); const t = document.getElementById('toast'); t.innerText = 'Network error during fallback'; t.style.display='block'; setTimeout(()=> t.style.display='none',3200); return; }
        } else {
          const msg = (data && (data.error||data.message)) || r.statusText || 'unknown error'; const t = document.getElementById('toast'); t.innerText = 'Save failed: ' + msg; t.style.display='block'; setTimeout(()=> t.style.display='none',3200); return;
        }
      }
      const newBio = document.createElement('div'); newBio.id='bio'; newBio.style.fontSize='12px'; newBio.style.color='#666'; newBio.innerText = val; parent.replaceChild(newBio, wrapper);
      newBio.removeAttribute('data-editing');
      const t = document.getElementById('toast'); t.innerText = 'Bio updated'; t.style.display='block'; setTimeout(()=> t.style.display='none',2000);
    }catch(err){ console.error('save bio err', err); alert('Network error'); }
  });
});


document.getElementById('searchBtn').addEventListener('click', ()=>{
  const q = document.getElementById('search').value.trim();
  const sel = document.getElementById('sortSelect');
  const chosen = sel ? sel.value : 'latest';
  if (chosen === 'oldest') {
    loadFeed('recent', q).then(()=>{
      const feed = document.getElementById('feed');
      const nodes = Array.from(feed.childNodes || []).reverse();
      feed.innerHTML = '';
      nodes.forEach(n => feed.appendChild(n));
    });
    return;
  }
  loadFeed('recent', q);
});

async function loadFeed(sort='recent', filter=''){
  const res = await fetch('/api/posts');
  const data = await res.json();
  postsCache = data;
  let list = data.slice();
  if (filter) {
    const q = filter.toLowerCase();
    list = list.filter(p => p.title.toLowerCase().includes(q) || p.content.toLowerCase().includes(q));
  }
  if (sort === 'engaged') {
    list.sort((a,b)=> ( (b.likes+b.dislikes+b.comments.length) - (a.likes+a.dislikes+a.comments.length)));
  } else {

    list.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
  }
  const feed = document.getElementById('feed');
  feed.innerHTML = '';


  const users = Array.from(new Set(list.map(p => p.username)));
  const missing = users.filter(name => !pfpCache[name]);
  if (missing.length) {
    await Promise.all(missing.map(async name => {
      try{
        const r = await fetch('/api/user/'+encodeURIComponent(name));
        if (!r.ok) { pfpCache[name] = '/default-pfp.png'; return; }
        const obj = await r.json(); pfpCache[name] = obj && obj.pfp ? obj.pfp : '/default-pfp.png';
      }catch(e){ pfpCache[name] = '/default-pfp.png'; }
    }));
  }
  list.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'post-card';
   div.innerHTML = `
  <div class="post-header">
    <div class="post-title-year">
      <span class="post-title">${escapeHtml(p.title)}</span>
      ${p.year ? `<span class="post-sep">·</span><span class="post-year">${escapeHtml(p.year)}</span>` : ''}
    </div>
    ${p.username===user?'<button data-id="'+p.id+'" class="delete-post-btn"></button>':''}
    
  </div>
  <div class="post-meta">
    <a href="/profile.html?username=${encodeURIComponent(p.username)}" style="display:inline-flex;align-items:center;text-decoration:none;color:inherit"><img src="${escapeHtml(pfpCache[p.username]||'/default-pfp.png')}" class="pfp-sm" alt="pfp">${escapeHtml(p.username)}</a><span class="meta-sep">·</span>${new Date(p.createdAt).toLocaleString()}
  </div>
  <div class="post-content">${escapeHtml(p.content)}</div>
  <div class="post-actions">
    <button class="like-btn${ (p.reactions && p.reactions.some(r=>r.username===user && r.type==='like')) ? ' pressed' : '' }" data-id="${p.id}" aria-label="Like"><span class="action-icon">⇧</span><span class="action-count">${p.likes}</span></button>
    <button class="dislike-btn${ (p.reactions && p.reactions.some(r=>r.username===user && r.type==='dislike')) ? ' pressed' : '' }" data-id="${p.id}" aria-label="Dislike"><span class="action-icon">⇩</span><span class="action-count">${p.dislikes}</span></button>
  </div>
  <div class="comment">
    ${p.comments.map(c=>`
      <div class="comment-item">
        <div>${escapeHtml(c.username)}: ${escapeHtml(c.content)}</div>
        ${c.username===user?'<button data-post="'+p.id+'" data-c="'+c.id+'" class="del-c"></button>':''}
      </div>`).join('')}
    <div style="display:flex;gap:8px;margin-top:8px">
      <input class="comment-input" data-id="${p.id}" placeholder="Add a comment">
      <button class="add-c-btn" data-id="${p.id}">➣</button>
    </div>
  </div>
`;
    feed.appendChild(div);
  });
  attachFeedEvents();
}

function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

async function attachFeedEvents(){
  document.querySelectorAll('.like-btn').forEach(b=>{
    b.onclick = async ()=> {
      const id = b.getAttribute('data-id');
      if (reactionLocks[id]) return; 
      if (b.disabled) return;
      reactionLocks[id] = true;
      const likeBtn = b;
      const dislikeBtns = Array.from(document.querySelectorAll(`.dislike-btn[data-id="${id}"]`));
      likeBtn.disabled = true; dislikeBtns.forEach(d=>d.disabled = true);
      try {
        const r = await fetch('/api/posts/react',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,type:'like', username: user})});
        if (r.status === 429) {

        }
      } catch(e){ console.error('react err', e); }
      await loadFeed(currentSort,document.getElementById('search').value);
      loadPostCount();
      reactionLocks[id] = false;
      const newLike = document.querySelector(`.like-btn[data-id="${id}"]`);
      if (newLike) newLike.disabled = false;
      Array.from(document.querySelectorAll(`.dislike-btn[data-id="${id}"]`)).forEach(d=>d.disabled=false);
    };
  });
  document.querySelectorAll('.dislike-btn').forEach(b=>{
    b.onclick = async ()=> {
      const id = b.getAttribute('data-id');
      if (reactionLocks[id]) return;
      if (b.disabled) return;
      reactionLocks[id] = true;
      const dislikeBtn = b;
      const likeBtns = Array.from(document.querySelectorAll(`.like-btn[data-id="${id}"]`));
      dislikeBtn.disabled = true; likeBtns.forEach(d=>d.disabled = true);
      try {
        const r = await fetch('/api/posts/react',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,type:'dislike', username: user})});
        if (r.status === 429) {
 
        }
      } catch(e){ console.error('react err', e); }
      await loadFeed(currentSort,document.getElementById('search').value);
      loadPostCount();
      reactionLocks[id] = false;
      const newDislike = document.querySelector(`.dislike-btn[data-id="${id}"]`);
      if (newDislike) newDislike.disabled = false;
      Array.from(document.querySelectorAll(`.like-btn[data-id="${id}"]`)).forEach(d=>d.disabled=false);
    };
  });
  document.querySelectorAll('.delete-post-btn').forEach(b=>{
    b.onclick = async ()=> {
      const id = b.getAttribute('data-id');
      if (!confirm('Delete this post? This action cannot be undone.')) return;
      await fetch('/api/posts/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,username:user})});
      loadFeed(currentSort,document.getElementById('search').value);
      loadPostCount();
    };
  });
  document.querySelectorAll('.add-c-btn').forEach(b=>{
    b.onclick = async ()=> {
      const id = b.getAttribute('data-id');
      const input = document.querySelector('.comment-input[data-id="'+id+'"]');
      const text = input.value.trim();
      if (!text) return;
      await fetch('/api/posts/comment',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({postId:id,username:user,content:text})});
      input.value='';
      loadFeed(currentSort,document.getElementById('search').value);
    };
  });
  document.querySelectorAll('.del-c').forEach(b=>{
    b.onclick = async ()=> {
      const postId = b.getAttribute('data-post');
      const cId = b.getAttribute('data-c');
      if (!confirm('Delete this comment?')) return;
      await fetch('/api/posts/comment/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({postId,commentId:cId,username:user})});
      loadFeed(currentSort,document.getElementById('search').value);
    };
  });
}

let currentSort = 'recent';

document.getElementById('postBtn').addEventListener('click', async ()=>{
  const title = document.getElementById('title').value.trim();
  const year = document.getElementById('year').value.trim();
  const content = document.getElementById('content').value.trim();
  if (!title || !year || !content) return;
  await fetch('/api/posts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:user,title,year,content})});
  document.getElementById('title').value=''; document.getElementById('year').value=''; document.getElementById('content').value='';
  loadFeed(currentSort,document.getElementById('search').value);
  loadPostCount();
});

document.getElementById('search').addEventListener('input', function(){
  const q = this.value.trim();
  if (!q) { loadFeed(currentSort,''); return; }
  if (q === 'most engaged') { currentSort='engaged'; loadFeed('engaged',''); return; }
  currentSort='recent';

  const sel = document.getElementById('sortSelect');
  const chosen = sel ? sel.value : 'latest';
  if (chosen === 'oldest') {

    loadFeed('recent',q).then(()=>{
      const feed = document.getElementById('feed');
      const nodes = Array.from(feed.childNodes || []).reverse();
      feed.innerHTML = '';
      nodes.forEach(n => feed.appendChild(n));
    });
    return;
  }
  loadFeed('recent',q);
});


document.getElementById('sortSelect').addEventListener('change', function(){
  const v = this.value;
  if (v === 'latest') loadFeed('recent', document.getElementById('search').value);
  else if (v === 'oldest') {
 
    loadFeed('recent', document.getElementById('search').value).then(()=>{
      const feed = document.getElementById('feed');
      const nodes = Array.from(feed.childNodes || []).reverse();
      feed.innerHTML = '';
      nodes.forEach(n => feed.appendChild(n));
    });
  }
});

document.getElementById('navNotif').addEventListener('click', ()=> location.href='/notification.html');
document.getElementById('navFeed').addEventListener('click', ()=>{ document.getElementById('search').value=''; currentSort='recent'; loadFeed('recent',''); });

async function fetchNotifCount(){
  try{
    const res = await fetch('/api/notifications/'+user);
    if (!res.ok) return;
    const d = await res.json();
    const total = (d.comments?d.comments.length:0) + (d.reactions?d.reactions.length:0);
    const btn = document.getElementById('navNotif');
    btn.innerText = total ? 'Notifications ('+total+')' : 'Notifications';
  }catch(e){ console.error('notif count err', e); }
}

fetchNotifCount();
setInterval(fetchNotifCount, 5000);
document.getElementById('navYou').addEventListener('click', ()=>{
  
  const feed = document.getElementById('feed');
  feed.innerHTML = '';
  const list = postsCache.filter(p => p.username === user);
  if (list.length === 0) { feed.innerHTML = '<div style="padding:12px;color:#666">You have not posted yet.</div>'; return; }
  (async function(){
    if (!postsCache.length){
      try { const r = await fetch('/api/posts'); postsCache = await r.json(); } catch(e){ console.error(e); }
    }
    list.forEach(p=>{
      const div = document.createElement('div');
      div.className = 'post-card';
      div.innerHTML = `
  <div class="post-header">
    <div class="post-title-year">
      <span class="post-title">${escapeHtml(p.title)}</span>
      ${p.year ? `<span class="post-sep">·</span><span class="post-year">${escapeHtml(p.year)}</span>` : ''}
    </div>
    ${p.username===user?'<button data-id="'+p.id+'" class="delete-post-btn"></button>':''}
  </div>
  <div class="post-meta">
    <a href="/profile.html?username=${encodeURIComponent(p.username)}" style="display:inline-flex;align-items:center;text-decoration:none;color:inherit"><img src="${escapeHtml(pfpCache[p.username]||'/default-pfp.png')}" class="pfp-sm" alt="pfp">${escapeHtml(p.username)}</a><span class="meta-sep">·</span>${new Date(p.createdAt).toLocaleString()}
  </div>
  <div class="post-content">${escapeHtml(p.content)}</div>
  <div class="post-actions">
    <button class="like-btn${ (p.reactions && p.reactions.some(r=>r.username===user && r.type==='like')) ? ' pressed' : '' }" data-id="${p.id}" aria-label="Like"><span class="action-icon">⇧</span><span class="action-count">${p.likes}</span></button>
    <button class="dislike-btn${ (p.reactions && p.reactions.some(r=>r.username===user && r.type==='dislike')) ? ' pressed' : '' }" data-id="${p.id}" aria-label="Dislike"><span class="action-icon">⇩</span><span class="action-count">${p.dislikes}</span></button>
  </div>
  <div class="comment">
    ${p.comments.map(c=>`
      <div class="comment-item">
        <div>${escapeHtml(c.username)}: ${escapeHtml(c.content)}</div>
        ${c.username===user?'<button data-post="'+p.id+'" data-c="'+c.id+'" class="del-c"></button>':''}
      </div>`).join('')}
    <div style="display:flex;gap:8px;margin-top:8px">
      <input class="comment-input" data-id="${p.id}" placeholder="Add a comment">
      <button class="add-c-btn" data-id="${p.id}">➣</button>
    </div>
  </div>
`;
      feed.appendChild(div);
    });
  })();
  attachFeedEvents();
});

loadFeed();
</script>
</body>
</html>
